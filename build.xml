<project name="songtickerli" default="test" 
	description="This buildfile is responsiblle for running tests and publishing songtickerli.">
	<property file="build.properties"/>

	<!-- -->
	<taskdef name="sync" classname="phing.tasks.ext.FileSyncTask" />

	<target name="test">
		<!-- not implemented ;) -->
	</target>

	<target name="stage" depends="pack-js,flxhr">
		<copy todir="work" overwrite="true">
			<fileset dir="htdocs/">
				<include name="*.html"/>
				<include name="*.gif"/>
				<include name="*.png"/>
				<include name="*.ico"/>
				<include name="*.xml"/>
				<include name="songtickerli.js"/>
				<include name="facebook/"/>
			</fileset>
		</copy>
	</target>

	<target name="pack-js">
		<copy todir="work/" overwrite="true">
			<fileset dir="htdocs/">
				<include name="*.js"/>
				<exclude name="songtickerli.js"/>
			</fileset>
			<filterchain>
					<filterreader classname="phing.filters.JSPackerFilter">
						<param name="encoding" value="Numeric"/>
						<param name="fastDecode" value="true"/>
						<param name="specialCharacters" value="false"/>
					</filterreader>
			</filterchain>
		</copy>
	</target>

	<target name="flxhr">
		<untar file="packages/flXHR-1.0.5.tar.gz" todir="temp/"/>
		<copy todir="work/flensed" overwrite="true">
			<fileset dir="temp/flensed-1.0/deploy">
				<include name="*"/>
			</fileset>
		</copy>
	</target>

	<target name="jxhr">
		<unzip file="packages/jXHR-0.1.zip" todir="temp/"/>
		<copy todir="work/jxhr" overwrite="true">
			<fileset dir="temp/">
				<include name="*min.js"/>
			</fileset>
		</copy>
	</target>

	<target name="publish" depends="stage">
		<!-- takes the current checkout and uses the FileSyncTask from my portage overlay 
		     to publish it to a location defined in build.properties -->
		<sync sourcedir="work/"
		      destinationdir="${publish.destination}htdocs/"
		      excludefile="build.publish.exclude"
		      listonly="false"
		      verbose="true"/>
		<chmod mode="744">
			<fileset dir="${publish.destination}htdocs/">
				<include name="*.*"/>
				<include name="flensed/*.*"/>
				<include name="flxhr/*.*"/>
			</fileset>
		</chmod>
	</target>
</project>
